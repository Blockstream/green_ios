stages:
    - build
    - test

build_release_iphone:
  stage: build
  tags:
    - osx
  script:
    - cd $CI_PROJECT_DIR
    - ./tools/build.sh --update-cocoapods --iphone static

build_tag_release_export:
  stage: build
  when: manual
  artifacts:
    name: "green-ios-release-$CI_COMMIT_REF_NAME"
    expire_in: 1 day
    when: on_success
    paths:
      - build/Green.ipa
  tags:
    - fastosx
    - osx
  script:
    - cd $CI_PROJECT_DIR
    - ./tools/build.sh --build-gdk --sign-and-export --update-cocoapods --iphone static

ui_tests:
  stage: test
  tags:
    - osx
  when: manual
  artifacts:
    paths:
      - fastlane/screenshots
      - fastlane/logs
  before_script:
    - gem install bundler
    - bundle install
    - export TEST_DEVICE="iPhone 11"
    - xcrun simctl privacy $TEST_DEVICE grant all io.blockstream.green

  script:
    - fastlane tests
